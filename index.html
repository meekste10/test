<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Holland Homes • PTO Dashboard (Daily)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <style>
    :root { --brand:#184A30; --ink:#1c1c1c; --muted:#6b7280; --bg:#f7f7f7; --card:#ffffff; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin:0; background:var(--bg); color:var(--ink); }
    header { background:var(--brand); color:#fff; padding:16px 20px; }
    header h1 { margin:0; font-size:18px; letter-spacing:.3px; }
    .wrap { max-width:1200px; margin: 0 auto; padding: 20px; }
    .row { display:grid; gap:16px; }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .card { background:var(--card); border:1px solid #e5e7eb; border-radius:10px; padding:14px; }
    .kpi { display:flex; align-items:baseline; gap:8px; }
    .kpi .big { font-size:28px; font-weight:700; }
    .kpi .label { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.6px; }
    .list { margin: 8px 0 0; padding:0; list-style:none; max-height:260px; overflow:auto; }
    .list li { padding:8px 0; border-bottom:1px dashed #eee; font-size:14px; display:flex; justify-content:space-between; gap:10px; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fafafa; color:#374151; }
    .toolbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .toolbar input, .toolbar select { border:1px solid #d1d5db; border-radius:8px; padding:8px 10px; background:#fff; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:10px 8px; border-bottom:1px solid #eee; text-align:left; }
    th { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; }
    .muted { color:var(--muted); }
    .footer { color:var(--muted); font-size:12px; margin-top:10px; }
    .warn { color:#a16207; font-weight:600; }
    .ok { color:#14532d; font-weight:600; }
    canvas { width:100%; height:280px; }
    @media (max-width: 960px){ .grid-4, .grid-3 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header><h1>Holland Homes — PTO & Coverage (Daily)</h1></header>
  <div class="wrap">
    <div class="toolbar card" style="justify-content:space-between;">
      <div class="toolbar">
        <label>Date:
          <input id="dateInput" type="date" />
        </label>
        <label>Team:
          <select id="teamFilter"><option value="">All Teams</option></select>
        </label>
        <label>Search:
          <input id="searchInput" type="search" placeholder="Name or role…" />
        </label>
      </div>
      <div class="toolbar">
        <button id="refreshBtn">Reload Data</button>
        <span class="footer">Data refreshes daily from CSV • <span id="asOf"></span></span>
      </div>
    </div>

    <div class="row grid-4">
      <div class="card kpi"><span class="big" id="outToday">0</span><span class="label">Out (Selected Day)</span></div>
      <div class="card kpi"><span class="big" id="teamsImpacted">0</span><span class="label">Teams Impacted</span></div>
      <div class="card kpi"><span class="big" id="coveragePct">100%</span><span class="label">Coverage</span></div>
      <div class="card kpi"><span class="big" id="next7">0</span><span class="label">Upcoming (Next 7 Days)</span></div>
    </div>

    <div class="row grid-3" style="margin-top:16px;">
      <div class="card">
        <h3 style="margin:0 0 8px;">Who’s Out</h3>
        <ul class="list" id="outList"></ul>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px;">Next 7 Days</h3>
        <ul class="list" id="nextList"></ul>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px;">Coverage by Team (Next 7 Days)</h3>
        <canvas id="coverageChart" aria-label="Coverage by team"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3 style="margin:0 0 8px;">Balances (Reference)</h3>
      <table id="balTable">
        <thead>
          <tr>
            <th>Employee</th><th>Team</th><th>Role</th><th>Manager</th><th>PTO Balance (hrs)</th><th>Last Updated</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="footer">Balances are informational; approval still follows normal process.</div>
    </div>
  </div>

  <!-- CSV parsing + charts -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // ====== CONFIG ======
    // If hosting pto.csv in same repo root: use './pto.csv'
    // If hosting in /data: use './data/pto.csv'
    // For raw GitHub URL, use: 'https://raw.githubusercontent.com/<org>/<repo>/<branch>/pto.csv'
    const PTO_CSV_URL = './pto.csv';
    const BALANCES_CSV_URL = './pto_balances.csv'; // optional; fallback if missing

    // ====== UTIL ======
    const fmt = (d) => new Date(d + "T00:00:00");
    const todayISO = () => new Date().toISOString().slice(0,10);
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
    const iso = (d) => d.toISOString().slice(0,10);
    const within = (d, a, b) => d >= a && d <= b;

    // ====== STATE ======
    let PTO = [];        // rows of PTO events
    let BAL = [];        // rows of balances
    let teams = new Set();
    let coverageChart;

    // ====== DOM ======
    const dateInput = document.getElementById('dateInput');
    const teamFilter = document.getElementById('teamFilter');
    const searchInput = document.getElementById('searchInput');
    const refreshBtn = document.getElementById('refreshBtn');

    const outTodayEl = document.getElementById('outToday');
    const teamsImpactedEl = document.getElementById('teamsImpacted');
    const coveragePctEl = document.getElementById('coveragePct');
    const next7El = document.getElementById('next7');

    const outList = document.getElementById('outList');
    const nextList = document.getElementById('nextList');
    const asOf = document.getElementById('asOf');

    const balTableBody = document.querySelector('#balTable tbody');

    // ====== LOADERS ======
    async function loadCSV(url) {
      const cacheBust = '?v=' + todayISO(); // daily refresh
      const res = await fetch(url + cacheBust, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to fetch ' + url);
      const text = await res.text();
      return new Promise((resolve) => {
        Papa.parse(text, { header:true, skipEmptyLines:true, complete: (out)=> resolve(out.data) });
      });
    }

    async function init() {
      dateInput.value = todayISO();
      try {
        PTO = await loadCSV(PTO_CSV_URL);
      } catch (e) {
        console.error(e);
        PTO = [];
      }
      try {
        BAL = await loadCSV(BALANCES_CSV_URL);
      } catch (e) {
        // Balances are optional; ignore if not found
        BAL = [];
      }
      asOf.textContent = 'As of ' + new Date().toLocaleString();

      // Collect teams
      PTO.forEach(r => { if (r.Team) teams.add(r.Team); });
      BAL.forEach(r => { if (r.Team) teams.add(r.Team); });
      [...teams].sort().forEach(t => {
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = t;
        teamFilter.appendChild(opt);
      });

      renderAll();
    }

    function subsetFilters(row) {
      const team = teamFilter.value.trim().toLowerCase();
      const q = searchInput.value.trim().toLowerCase();
      if (team && (row.Team||'').toLowerCase() !== team) return false;
      if (q) {
        const blob = [row.Employee, row.Team, row.Role, row.Manager, row.Reason].map(x=>(x||'').toLowerCase()).join('|');
        if (!blob.includes(q)) return false;
      }
      return true;
    }

    function renderAll() {
      const selectedDay = fmt(dateInput.value || todayISO());
      const start = selectedDay;
      const end7 = addDays(selectedDay, 7);

      // ----- Out today -----
      const out = PTO.filter(r => {
        if (!r.Start || !r.End) return false;
        const s = fmt(r.Start);
        const e = fmt(r.End);
        return within(selectedDay, s, e) && subsetFilters(r);
      });

      outTodayEl.textContent = out.length;
      const teamsHit = new Set(out.map(r => r.Team));
      teamsImpactedEl.textContent = teamsHit.size;

      outList.innerHTML = '';
      out.sort((a,b)=> (a.Team||'').localeCompare(b.Team||''));
      out.forEach(r => {
        const li = document.createElement('li');
        const left = document.createElement('div');
        left.textContent = `${r.Employee || '—'} (${r.Role || '—'})`;
        const right = document.createElement('div');
        right.innerHTML = `<span class="pill">${r.Team || 'Team'}</span> <span class="muted">${r.Reason || 'PTO'}</span>`;
        li.appendChild(left); li.appendChild(right);
        outList.appendChild(li);
      });

      // ----- Next 7 days -----
      const upcoming = PTO.filter(r => {
        if (!r.Start || !r.End) return false;
        const s = fmt(r.Start);
        const e = fmt(r.End);
        // Any overlap with [start, end7]
        const overlap = e >= start && s <= end7;
        return overlap && subsetFilters(r);
      });

      next7El.textContent = upcoming.length;
      nextList.innerHTML = '';
      upcoming.sort((a,b)=> fmt(a.Start)-fmt(b.Start));
      upcoming.forEach(r=>{
        const li = document.createElement('li');
        const left = document.createElement('div');
        const range = `${r.Start} → ${r.End}`;
        left.textContent = `${r.Employee || '—'} • ${range}`;
        const right = document.createElement('div');
        right.innerHTML = `<span class="pill">${r.Team || 'Team'}</span> <span class="muted">${r.Reason || 'PTO'}</span>`;
        li.appendChild(left); li.appendChild(right);
        nextList.appendChild(li);
      });

      // ----- Coverage -----
      // Assume BAL (or PTO) includes headcount per team via distinct employees in balances.
      const byTeam = {};
      const headcount = {};
      (BAL.length ? BAL : PTO).forEach(r => {
        const t = r.Team || 'Unknown';
        headcount[t] = headcount[t] || new Set();
        headcount[t].add(r.Employee || r.EmpID || '???');
      });

      Object.keys(headcount).forEach(t => { byTeam[t] = 0; });

      out.forEach(r => {
        const t = r.Team || 'Unknown';
        byTeam[t] = (byTeam[t] || 0) + 1;
      });

      const labels = Object.keys(headcount).sort();
      const coverage = labels.map(t => {
        const total = headcount[t] ? headcount[t].size : 0;
        const outN = byTeam[t] || 0;
        return total > 0 ? Math.max(0, Math.round((1 - outN/total)*100)) : 100;
      });

      // Overall coverage %
      const totals = labels.reduce((acc,t)=> acc + (headcount[t]? headcount[t].size:0), 0);
      const outs = Object.values(byTeam).reduce((a,b)=> a+b, 0);
      const cov = totals>0 ? Math.round((1 - outs/totals)*100) : 100;
      coveragePctEl.textContent = cov + '%';
      coveragePctEl.className = cov < 80 ? 'big warn' : 'big ok';

      // Chart
      const ctx = document.getElementById('coverageChart');
      if (coverageChart) coverageChart.destroy();
      coverageChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Coverage %', data: coverage }] },
        options: {
          responsive: true,
          plugins: { legend: { display:false } },
          scales: { y: { beginAtZero:true, max:100, ticks: { callback: v => v + '%' } } }
        }
      });

      // ----- Balances table -----
      balTableBody.innerHTML = '';
      BAL.filter(subsetFilters).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.Employee||''}</td>
          <td>${r.Team||''}</td>
          <td>${r.Role||''}</td>
          <td>${r.Manager||''}</td>
          <td>${r.PTO_Balance_Hours||''}</td>
          <td class="muted">${r.LastUpdated||''}</td>
        `;
        balTableBody.appendChild(tr);
      });
    }

    // ====== EVENTS ======
    dateInput.addEventListener('change', renderAll);
    teamFilter.addEventListener('change', renderAll);
    searchInput.addEventListener('input', renderAll);
    refreshBtn.addEventListener('click', init);

    // ====== START ======
    init();
  </script>
</body>
</html>