<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Holland Homes • PTO Requests (Range)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="preconnect" href="https://cdnjs.cloudflare.com" />
<style>
  :root { --brand:#184A30; --ink:#1c1c1c; --muted:#6b7280; --bg:#f7f7f7; --card:#ffffff; }
  * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  body { margin:0; background:var(--bg); color:var(--ink); }
  header { background:var(--brand); color:#fff; padding:16px 20px; }
  header h1 { margin:0; font-size:18px; letter-spacing:.2px; }
  .wrap { max-width:1200px; margin:0 auto; padding:16px; }
  .row { display:grid; gap:12px; }
  .grid-4 { grid-template-columns: repeat(4, 1fr); }
  .grid-3 { grid-template-columns: repeat(3, 1fr); }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
  .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .toolbar input, .toolbar select, .toolbar button, .toolbar label { font-size:14px; }
  .toolbar input, .toolbar select, .toolbar button { border:1px solid #d1d5db; border-radius:8px; padding:8px 10px; background:#fff; }
  .kpi { display:flex; align-items:baseline; gap:8px; }
  .kpi .big { font-size:26px; font-weight:700; }
  .kpi .label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; }
  .list { margin: 8px 0 0; padding:0; list-style:none; }
  .list li { padding:8px 0; border-bottom:1px dashed #eee; font-size:14px; display:flex; justify-content:space-between; gap:10px; }
  .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fafafa; color:#374151; }
  .muted { color:var(--muted); }
  .footer { color:var(--muted); font-size:12px; margin-top:8px; }
  .ok { color:#14532d; font-weight:600; }
  .warn { color:#a16207; font-weight:600; }

  /* Scrollable frames */
  .scroll-card { 
    max-height: calc(var(--vh, 1vh) * 35);
    overflow:auto; border-radius:12px; -webkit-overflow-scrolling:touch;
    background: linear-gradient(#ffffff, #ffffff) padding-box,
                linear-gradient(180deg, rgba(0,0,0,0.04), transparent 24px) border-box;
  }
  .scroll-card h3 { position: sticky; top: 0; background: var(--card); padding-bottom:6px; margin-top:0; }

  canvas { width:100%; height:260px; }

  /* Table: pan + sticky headers */
  .table-wrap { overflow:auto; max-height: calc(var(--vh, 1vh) * 40); -webkit-overflow-scrolling:touch; border:1px solid #e5e7eb; border-radius:12px; }
  table { width:100%; border-collapse: collapse; font-size:14px; min-width: 720px; }
  th, td { padding:10px 8px; border-bottom:1px solid #eee; text-align:left; }
  th { font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.5px; position: sticky; top: 0; background: #fff; z-index: 1; }

  @media (pointer: coarse) { .toolbar input, .toolbar select, .toolbar button { padding:12px 14px; font-size:16px; } }
  @media (max-width: 960px){ .grid-4, .grid-3 { grid-template-columns: 1fr; } canvas { height: 200px; } .scroll-card { max-height: calc(var(--vh, 1vh) * 32); } }
  /* Card view for balances on narrow phones */
  @media (max-width: 720px){
    table { min-width: 0; }
    table thead { display: none; }
    table, tbody, tr, td { display:block; width: 100%; }
    tr { border-bottom: 1px solid #eee; margin: 6px 0; padding: 8px 6px; border-radius: 8px; background: #fff; }
    td { border-bottom: none; padding: 6px 0; }
    td::before { content: attr(data-label); display:block; font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.4px; margin-bottom:2px; }
  }

  .btn { cursor:pointer; }
</style>
</head>
<body>
<header><h1>Holland Homes — PTO Requests (Range)</h1></header>

<div class="wrap">

  <!-- Controls -->
  <div class="toolbar card" style="justify-content:space-between;">
    <div class="toolbar">
      <label>From: <input id="dateFrom" type="date" /></label>
      <label>To: <input id="dateTo" type="date" /></label>

      <!-- Quick ranges -->
      <button class="btn" id="rngToday">Today</button>
      <button class="btn" id="rng7">Next 7 Days</button>
      <button class="btn" id="rng30">Next 30 Days</button>

      <label>Department:
        <select id="deptFilter"><option value="">All</option></select>
      </label>
      <label>Manager:
        <select id="mgrFilter"><option value="">All</option></select>
      </label>
      <label>Type:
        <select id="typeFilter">
          <option value="">All</option>
          <option>Vacation</option><option>Sick</option><option>Unpaid</option>
        </select>
      </label>
      <label>Search: <input id="searchInput" type="search" placeholder="Name, dept, manager…" /></label>
    </div>
    <div class="toolbar">
      <button id="refreshBtn" class="btn" type="button">Reload Data</button>
      <span class="footer">From CSV • <span id="asOf"></span></span>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row grid-4">
    <div class="card kpi"><span class="big" id="kpiRequests">0</span><span class="label">Requests in Range</span></div>
    <div class="card kpi"><span class="big" id="kpiPeople">0</span><span class="label">Unique Employees</span></div>
    <div class="card kpi"><span class="big" id="kpiDepts">0</span><span class="label">Depts Impacted</span></div>
    <div class="card kpi"><span class="big" id="kpiDays">0</span><span class="label">Total Person‑Days</span></div>
  </div>

  <!-- Lists + Chart -->
  <div class="row grid-3" style="margin-top:12px;">
    <div class="card scroll-card">
      <h3>Requests (Overlapping Range)</h3>
      <ul class="list" id="reqList"></ul>
    </div>
    <div class="card scroll-card">
      <h3>By Employee (Totals in Range)</h3>
      <ul class="list" id="empList"></ul>
    </div>
    <div class="card scroll-card">
      <h3>By Team in Range</h3>
      <canvas id="deptChart" aria-label="Requests by team"></canvas>
    </div>
  </div>

  <!-- Balances -->
  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">Balances (Reference)</h3>
    <div class="table-wrap">
      <table id="balTable">
        <thead>
          <tr>
            <th>Employee</th><th>Team/Dept</th><th>Manager</th><th>PTO Balance (hrs)</th><th>Last Updated</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="toolbar" style="margin-top:8px;">
      <a href="./pto_requests_2025.csv" download>⬇️ Download pto_requests_2025.csv</a>
      <a href="./pto_balances.csv" download>⬇️ Download pto_balances.csv</a>
    </div>
    <div class="footer">Balances are informational; approvals follow the normal process.</div>
  </div>
</div>

<script>
  // Correct mobile viewport units (iOS Safari)
  function setVH(){ const vh=window.innerHeight*0.01; document.documentElement.style.setProperty('--vh', vh+'px'); }
  window.addEventListener('resize', setVH); window.addEventListener('orientationchange', setVH); setVH();
</script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // ===== CONFIG =====
  const REQUESTS_CSV = './pto_requests_2025.csv';
  const BALANCES_CSV = './pto_balances.csv'; // optional

  // ===== UTIL =====
  const MS_DAY = 24*60*60*1000;
  const todayISO = () => new Date().toISOString().slice(0,10);
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

  function parseDate(d){
    if(!d) return null;
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(d)){ const [m,dd,y]=d.split('/').map(s=>parseInt(s,10)); return new Date(y,m-1,dd); }
    const t=new Date(d); return isNaN(t)?null:t;
  }
  function dayStart(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function dayISO(d){ return dayStart(d).toISOString().slice(0,10); }
  const num = (x)=>{ const n=parseFloat(String(x??'').replace(/,/g,'')); return isNaN(n)?0:n; };
  const isHalf = (ampm)=> (String(ampm||'').toUpperCase()==='AM' || String(ampm||'').toUpperCase()==='PM');

  function overlapDaysInRange(r, rs, re){
    // overlap between [s..e] and [rs..re], inclusive, with half-day edges
    const s=r.s, e=r.e; if(!s||!e) return 0;
    const a=dayStart(s), b=dayStart(e), R1=dayStart(rs), R2=dayStart(re);
    if(b < R1 || a > R2) return 0;
    const start = a < R1 ? R1 : a;
    const end   = b > R2 ? R2 : b;
    let days = Math.floor((end - start)/MS_DAY) + 1;

    // Half-day adjust only if the overlap includes the actual boundary day
    if(dayISO(start)===dayISO(a) && isHalf(r.sh)) days -= 0.5;
    if(dayISO(end)  ===dayISO(b) && isHalf(r.eh)) days -= 0.5;

    return Math.max(0, days);
  }

  async function loadCSV(url){
    const res = await fetch(url+'?v='+todayISO(), {cache:'no-store'});
    if(!res.ok) throw new Error('fetch failed '+url);
    const text = await res.text();
    return new Promise(resolve => Papa.parse(text, {header:true, skipEmptyLines:true, complete: out=>resolve(out.data)}));
  }

  // ===== STATE =====
  let REQ=[], BAL=[];
  let deptChart;

  // ===== DOM =====
  const dateFrom = document.getElementById('dateFrom');
  const dateTo   = document.getElementById('dateTo');
  const rngToday = document.getElementById('rngToday');
  const rng7     = document.getElementById('rng7');
  const rng30    = document.getElementById('rng30');

  const deptFilter = document.getElementById('deptFilter');
  const mgrFilter  = document.getElementById('mgrFilter');
  const typeFilter = document.getElementById('typeFilter');
  const searchInput= document.getElementById('searchInput');
  const asOf       = document.getElementById('asOf');

  const kpiRequests = document.getElementById('kpiRequests');
  const kpiPeople   = document.getElementById('kpiPeople');
  const kpiDepts    = document.getElementById('kpiDepts');
  const kpiDays     = document.getElementById('kpiDays');

  const reqList = document.getElementById('reqList');
  const empList = document.getElementById('empList');
  const balTableBody = document.querySelector('#balTable tbody');

  function normalizeRow(r){
    return {
      emp: (r['Employee Name']||'').trim(),
      dept: (r['Department']||'Unknown').trim(),
      mgr: (r['Direct Report']||'').trim(),
      type: (r['PTO Request Type']||'').trim(),
      s: parseDate(r['PTO Request Start Date']),
      e: parseDate(r['PTO Request End Date']),
      sh: r['Start AM/PM']||'',
      eh: r['End AM/PM']||'',
      totalDays: num(r['PTO Request Total Days']) || null,
      raw: r
    };
  }

  function passesFilters(r){
    const d=(deptFilter.value||'').toLowerCase();
    const m=(mgrFilter.value||'').toLowerCase();
    const t=(typeFilter.value||'').toLowerCase();
    const q=(searchInput.value||'').toLowerCase();
    if(d && r.dept.toLowerCase()!==d) return false;
    if(m && r.mgr.toLowerCase()!==m) return false;
    if(t && r.type.toLowerCase()!==t) return false;
    if(q){
      const blob=[r.emp,r.dept,r.mgr,r.type, r.raw['PTO Request Start Date'], r.raw['PTO Request End Date']]
        .map(x=>String(x||'').toLowerCase()).join('|');
      if(!blob.includes(q)) return false;
    }
    return true;
  }

  async function init(){
    // default range: Today -> Next 7 days
    const t = new Date();
    dateFrom.value = todayISO();
    dateTo.value   = addDays(t,7).toISOString().slice(0,10);

    try{ REQ=(await loadCSV(REQUESTS_CSV)).map(normalizeRow); }catch(e){ REQ=[]; console.error(e); }
    try{ BAL=await loadCSV(BALANCES_CSV); }catch(e){ BAL=[]; }
    asOf.textContent = new Date().toLocaleString();

    // Build dropdowns (de‑duped)
    const depts=[...new Set(REQ.map(r=>r.dept).filter(Boolean))].sort();
    const mgrs =[...new Set(REQ.map(r=>r.mgr ).filter(Boolean))].sort();
    deptFilter.innerHTML = '<option value="">All</option>' + depts.map(d=>`<option>${d}</option>`).join('');
    mgrFilter.innerHTML  = '<option value="">All</option>' + mgrs.map(m=>`<option>${m}</option>`).join('');

    renderAll();
  }

  function renderAll(){
    const rs = parseDate(dateFrom.value) || new Date();
    const re = parseDate(dateTo.value)   || rs;
    if(re < rs) { dateTo.value = dateFrom.value; return; }

    // Filter rows and compute overlap days within range
    const rows = REQ
      .filter(r => passesFilters(r))
      .map(r => ({...r, overlapDays: overlapDaysInRange(r, rs, re)}))
      .filter(r => r.overlapDays > 0);

    // KPIs
    kpiRequests.textContent = rows.length;
    kpiPeople.textContent   = new Set(rows.map(r=>r.emp)).size;
    kpiDepts.textContent    = new Set(rows.map(r=>r.dept)).size;
    const totalPersonDays   = rows.reduce((a,r)=>a + r.overlapDays, 0);
    kpiDays.textContent     = totalPersonDays;

    // Requests list
    reqList.innerHTML = '';
    rows
      .sort((a,b)=> (a.s-b.s) || a.emp.localeCompare(b.emp))
      .forEach(r=>{
        const li=document.createElement('li');
        li.innerHTML = `<div>${r.emp} • ${r.type}</div>
                        <div><span class="pill">${r.dept}</span> <span class="muted">${dayISO(r.s)} → ${dayISO(r.e)} • ${r.overlapDays}d in range</span></div>`;
        reqList.appendChild(li);
      });

    // By-employee totals in range
    const byEmp = {};
    rows.forEach(r=>{ byEmp[r.emp] = (byEmp[r.emp]||0) + r.overlapDays; });
    const empItems = Object.entries(byEmp).sort((a,b)=>b[1]-a[1]);
    empList.innerHTML='';
    empItems.forEach(([name,days])=>{
      const li=document.createElement('li');
      li.innerHTML = `<div>${name}</div><div class="muted">${days} day(s)</div>`;
      empList.appendChild(li);
    });

    // Chart: requests (or person-days) by department in range
    const byDept = {};
    rows.forEach(r=>{ byDept[r.dept] = (byDept[r.dept]||0) + r.overlapDays; });
    const labels = Object.keys(byDept).sort();
    const data   = labels.map(l=>byDept[l]);

    const ctx = document.getElementById('deptChart');
    if(window._deptChart) window._deptChart.destroy();
    window._deptChart = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ label:'Person‑Days in Range', data }] },
      options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });

    // Balances (optional)
    balTableBody.innerHTML = '';
    (BAL||[]).forEach(b=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Employee">${b.Employee||''}</td>
        <td data-label="Team/Dept">${b.Team||b.Department||''}</td>
        <td data-label="Manager">${b.Manager||''}</td>
        <td data-label="PTO Balance (hrs)">${b.PTO_Balance_Hours||''}</td>
        <td data-label="Last Updated" class="muted">${b.LastUpdated||''}</td>
      `;
      balTableBody.appendChild(tr);
    });
  }

  // Events
  document.getElementById('refreshBtn').addEventListener('click', init);
  dateFrom.addEventListener('change', renderAll);
  dateTo.addEventListener('change', renderAll);
  deptFilter.addEventListener('change', renderAll);
  mgrFilter.addEventListener('change', renderAll);
  typeFilter.addEventListener('change', renderAll);
  searchInput.addEventListener('input', renderAll);

  // Quick range buttons
  function setRange(start, end){ dateFrom.value = start.toISOString().slice(0,10); dateTo.value = end.toISOString().slice(0,10); renderAll(); }
  rngToday.addEventListener('click', ()=> { const t=new Date(); setRange(t,t); });
  rng7.addEventListener('click',    ()=> { const t=new Date(); setRange(t, addDays(t,7)); });
  rng30.addEventListener('click',   ()=> { const t=new Date(); setRange(t, addDays(t,30)); });

  // Start
  init();
</script>
</body>
</html>
